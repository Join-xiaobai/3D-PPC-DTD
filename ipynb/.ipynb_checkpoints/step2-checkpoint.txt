生物信息学分析流程的第二步，其核心目标是对来自两个不同 GEO 数据集（一个关于肺动脉高压的肺组织数据，一个关于右心室重构的心脏数据）进行差异表达分析，并通过功能富集分析来理解这些差异基因背后的生物学意义。

整个流程可以清晰地分为两大块：心脏（Heart）数据分析 和 肺（Lung）数据分析。

第一部分：心脏 (Heart) - GSE240921 数据集分析

该数据集研究的是肺动脉高压（PH）患者中适应不良性右心室（maladaptive RV, Cluster_B）与适应性右心室（adaptive RV, Cluster_A） 的单细胞 RNA-seq 数据。

数据清理：
    原始样本信息表 (info table) 混杂了大量技术参数行，导致分组错误。
    解决方案：只保留 group 列值为 Cluster_A 到 Cluster_E 的行，成功提取出 40 个真实样本（其中 Cluster_A 对照组 24 个，Cluster_B 病例组 4 个）。

差异表达分析：
    挑战：病例组样本量极小（n=4 vs n=24），导致统计功效低，即使变化很大，p值校正后也大多不显著。
    策略：不依赖 padj (FDR校正后的p值)，而是基于效应量（|log2FC|）进行筛选。
    方法：使用 Welch’s t 检验（不假设方差齐性），并过滤掉低表达基因。
    结果：识别出 3,145 个 |log2FC| ≥ 1 的候选基因。

基因注释与生物学解读：
    将原始的 Ensembl ID (如 ENSG00000...) 转换为标准的基因符号 (Gene Symbol)。
    关键发现：Top 上调基因（如 SPP1, TNC, SERPINE1, HMOX1）高度符合右心室病理重构的已知生物学机制（炎症、纤维化、氧化应激、胎儿基因重编程），验证了分析的可靠性。
    产出：生成了带注释的心脏候选基因列表 gse240921_rv_candidates_annotated.csv，作为“RV maladaptation signature”。

第二部分：肺 (Lung) - GSE117261 数据集分析

该数据集是一个肺动脉高压（PAH）患者 vs 对照组 的肺组织微阵列（Affymetrix）数据集，样本量大（58 PAH + 25 Control）。

数据预处理：
    从 Series Matrix 文件中解析出表达矩阵和样本分组信息。
    根据 GEO 元数据，将前58个样本标记为 PAH，后25个标记为 Control。

差异表达分析：
    挑战：微阵列数据已是 log2 转换后的值，不能再取 log。
    策略：由于严格阈值下显著基因很少，采用 Top 1000 变化最显著（无论 p 值）的探针进行后续分析，这是处理此类数据的常用方法。
    方法：计算 log2FC（直接相减），进行 t 检验和 FDR 校正。

探针注释：
    使用平台注释文件 GPL6244-17930.txt 获取探针对应的 RefSeq ID (GB_LIST)。
    利用 NCBI 的 gene2refseq 和 gene_info 文件，将 RefSeq ID 映射到官方基因符号。
    结果：成功注释了 697/1000 个探针，并对同一基因的多个探针进行去重，保留变化最大的一个。

功能富集分析 (GO/KEGG)：
    工具：使用 gseapy 库调用 Enrichr 进行富集分析。
    输入：去重后的 640 个唯一肺部差异基因。
    关键发现：富集结果极其显著且高度一致，主要集中在以下通路：
        补体与凝血级联（Complement and coagulation cascades）
        溶酶体/吞噬体（Lysosome/Phagosome）
        趋化因子信号通路（Chemokine signaling pathway）
        多种病原体感染通路（如金黄色葡萄球菌感染）
    生物学解读：这并非表示真实感染，而是强烈提示在 PAH 肺组织中存在先天免疫系统激活、巨噬细胞浸润和强烈的炎症反应，这与 PAH 的病理生理学完全吻合。

结果可视化：
    绘制了 GO 和 KEGG 富集结果的气泡图，直观展示了最显著的通路及其统计学显著性。

总结

step2.ipynb 成功完成了以下核心工作：

克服了两个数据集的不同挑战：
    对于小样本心脏数据（GSE240921），通过基于效应量（|log2FC|）的筛选，获得了具有强生物学意义的候选基因集。
    对于大样本肺部数据（GSE117261），通过 Top N 策略和严谨的注释流程，获得了高质量的差异基因列表。

进行了深入的功能解读：
    心脏分析结果与已知的 RV 重构机制高度一致。
    肺部富集分析揭示了 PAH 中核心的免疫-炎症-凝血病理轴。

生成了两个关键的、经过注释和生物学验证的基因列表（心脏和肺），这两个列表将在后续步骤（如步骤3）中被用于交叉整合，以寻找共同的、可作为药物靶点的核心调控因子。